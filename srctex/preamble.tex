\newcommand{\gitTag}{\input|"git describe"}
\usepackage{lipsum}
\usepackage{metalogo}
\usepackage{xcolor}
\usepackage{url}
\usepackage{fancyhdr}

% have to load this first, before loading fontsetup
\defaultfontfeatures{Numbers=OldStyle}

% New Computer Modern font. "default" option loads book weight.
\usepackage[default]{fontsetup}
%\addfontfeature{Numbers=Lowercase}

% section style, all section headings normal size
\usepackage{sectsty}
\allsectionsfont{\normalsize}

% section style, all section headings normal size bold, except chapter headings
\usepackage[bf,tiny,compact]{titlesec}

% Arabic font's ascenders, descenders, and diacritics increase Latex's line
% spacing irregularly for some lines more than others to result in a visually
% unappealing output.
%
% I tried setting \lineskiplimit=-\maxdimen as some had suggested this but it
% completely destroys linespacing in tables and around tikzpictures.
%
% Then I found that \smash forces a 0 depth and 0 height for it's argument. So
% the Arabic text is ignored by Latex for line spacing purposes. Call \smash on
% the Arabic text input to babel's \foreignlanguage as below.
%
% I also tried calling smash on the output of \foreignlanguage but that seemed
% to cause problems on chapter headings.
%
% However, with this solution, some itemized lists have Arabic text directly on
% top of each other and the diacritics collide. For these lists insert a
% \vphantom{\huge J} for each item to locally increase line spacing. See
% examples in script.Rmd and inna_and_its_sisters.Rmd.
%
% The other unsolved issue with the solution is that it messes up the bidi dir
% in the sidebar contents in my PDF reader
\NewCommandCopy{\oldforeignlanguage}{\foreignlanguage}
\renewcommand{\foreignlanguage}[2]{\oldforeignlanguage{#1}{\smash{#2}}}

% Add section symbol ยง to every (sub)section heading and reference
%\NewCommandCopy{\oldthesection}{\thesection}
%\renewcommand{\thesection}{\S\oldthesection}

% Fancy header
\renewcommand{\chaptermark}[1]{\markboth {\textsc{\MakeLowercase{\thechapter\ #1}}}{}}
\renewcommand{\sectionmark}[1]{\markright{\textsc{\MakeLowercase{\S\thesection\ }}}}
\pagestyle{fancy}
\fancyhf{}
%\fancyhead[LE]{\thepage\phantom{xxx}\itshape\nouppercase{Fundamentals of Standard Arabic}}
%\fancyhead[RO]{\itshape\nouppercase{\leftmark}\phantom{xxx}\thepage}
%\fancyhead[LE]{\thepage \ {\vrule height 13pt width 1pt} \itshape\nouppercase{Fundamentals of Standard Arabic}}
%\fancyhead[RO]{\itshape\nouppercase{\leftmark} \ {\vrule height 13pt width 1pt} \thepage}

%\fancyhead[LE]{\leavevmode\smash{\llap{\thepage\ \rule[-0.5em]{1pt}{1.5em}}}\phantom{x}\itshape\nouppercase{Fundamentals of Standard Arabic}}
%\fancyhead[RO]{\textsl{\nouppercase{\leftmark}}\phantom{x}\leavevmode\smash{\rlap{\rule[-0.5em]{1pt}{1.5em}\ \thepage}}}
%\fancyhead[LO]{\itshape\nouppercase{\rightmark}}
%\fancyhead[LO,RE]{\textsl{\nouppercase{https://adamiturabi.github.io/arabic-tutorial-book/}}}
\fancyhead[LE,RO]{\thepage}
\fancyhead[CO]{\nouppercase{\rightmark}}
\fancyhead[CE]{\nouppercase{\leftmark}}
\renewcommand{\headrulewidth}{0pt}

\fancyfoot[RE, RO]{\phantom{xxx}\\\phantom{xxx}\\\phantom{xxx}\\\phantom{xxx}\\\textcolor{gray}{\tiny{Author Names, \textit{Learn Standard Arabic}, \texttt{\gitTag}\\\url{https://adamiturabi.github.io/arabic-tutorial-book/}}}}

% Footer for chapter start pages:
\fancypagestyle{plain}{%
\fancyhf{}
\fancyfoot[RE, RO]{\phantom{xxx}\\\phantom{xxx}\\\phantom{xxx}\\\phantom{xxx}\\\textcolor{gray}{\tiny{Author Names, \textit{Learn Standard Arabic}, \texttt{\gitTag}\\\url{https://adamiturabi.github.io/arabic-tutorial-book/}}}}
\fancyfoot[CO]{\footnotesize\thepage}
}

% Blank pages (e.g., left hand pages between chapters should be completely blank. no headers even
\makeatletter
\def\cleardoublepage{\clearpage\if@twoside \ifodd\c@page\else
  \begingroup
    \mbox{}
    \vspace*{\fill}
    \begin{center}
      %This page intentionally contains only this sentence.
    \end{center}
    \vspace{\fill}
    \thispagestyle{empty}
    \newpage
    \if@twocolumn\mbox{}\newpage\fi
  \endgroup\fi\fi}
\makeatother

\usepackage[color={[gray]{0.85}}, fontsize=32pt, text={Work in progress. Not ready for study.}]{draftwatermark}

\widowpenalty10000
%\clubpenalty10000

\babelfont[arabic]{rm}
          [Language=Default]{Vazirmatn-Light}
\babelfont[arabic]{sf}
          [Language=Default]{Vazirmatn-Light}

% Reduce font size and line spacing for Table of contents
\usepackage{tocloft}

\renewcommand\cftchapfont{\footnotesize\bfseries}
\renewcommand\cftsecfont{\footnotesize}

\renewcommand\cftchappagefont{\footnotesize\bfseries}
\renewcommand\cftsecpagefont{\footnotesize}

\renewcommand\cftchapafterpnum{\vskip -0.2em}
\renewcommand\cftsecafterpnum {\vskip -0.2em}

%\frontmatter
